#!/usr/bin/env bash
#
# EZ - go-task 智能前端
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/ez-core.sh"

# -----------------------------------------------------------------------------
# 命令: version
# -----------------------------------------------------------------------------
cmd_version() {
    echo "ez version $EZ_VERSION"
    echo ""
    echo "Dependencies:"
    echo "  yq:   $("$YQ" --version 2>/dev/null | head -1)"
    echo "  task: $("$TASK" --version 2>/dev/null | head -1)"
}

# -----------------------------------------------------------------------------
# 命令: help
# -----------------------------------------------------------------------------
cmd_help() {
    cat << 'EOF'
EZ - go-task 智能前端

用法:
    ez <command> [options] [args]

命令:
    list              列出所有任务
    show <task>       显示任务详情
    run <task>        运行任务（交互式参数）
    version           显示版本信息
    help              显示帮助

选项:
    -t, --taskfile    指定 Taskfile 路径
    --dry-run         只显示命令，不执行

示例:
    ez list
    ez show build
    ez run build
    ez run build --dry-run
EOF
}

# -----------------------------------------------------------------------------
# 命令: list
# -----------------------------------------------------------------------------
cmd_list() {
    local taskfile
    taskfile=$(find_taskfile ".") || die "未找到 Taskfile"

    echo -e "${BOLD}Tasks in ${taskfile}:${NC}"
    echo ""

    local tasks
    tasks=$(get_tasks "$taskfile")

    if [[ -z "$tasks" ]]; then
        echo "  (无任务)"
        return
    fi

    while IFS= read -r name; do
        [[ -z "$name" ]] && continue
        local desc param_flag=""
        desc=$(get_task_prop "$taskfile" "$name" "desc")
        has_ez_params "$taskfile" "$name" && param_flag=" ${CYAN}[params]${NC}"
        printf "  ${GREEN}%-20s${NC} %s%s\n" "$name" "$desc" "$param_flag"
    done <<< "$tasks"
}

# -----------------------------------------------------------------------------
# 命令: show
# -----------------------------------------------------------------------------
cmd_show() {
    local task="${1:-}"
    [[ -z "$task" ]] && die "用法: ez show <task>"

    local taskfile
    taskfile=$(find_taskfile ".") || die "未找到 Taskfile"

    # 检查任务是否存在
    local exists
    exists=$("$YQ" eval ".tasks.\"$task\" // \"\"" "$taskfile")
    [[ -z "$exists" || "$exists" == "null" ]] && die "任务未找到: $task"

    echo -e "${BOLD}Task: ${GREEN}$task${NC}"
    echo ""

    # 描述
    local desc
    desc=$(get_task_prop "$taskfile" "$task" "desc")
    [[ -n "$desc" ]] && echo -e "${BOLD}Description:${NC} $desc" && echo ""

    # 命令
    echo -e "${BOLD}Commands:${NC}"
    "$YQ" eval ".tasks.\"$task\".cmds[].cmd // .tasks.\"$task\".cmds[]" "$taskfile" 2>/dev/null | while IFS= read -r cmd; do
        [[ -n "$cmd" ]] && echo "  - $cmd"
    done
    echo ""

    # EZ 参数
    if has_ez_params "$taskfile" "$task"; then
        echo -e "${BOLD}Parameters:${NC}"
        local params_json
        params_json=$(get_ez_params_json "$taskfile" "$task")
        local count
        count=$(echo "$params_json" | "$YQ" eval 'length' -)

        for ((i=0; i<count; i++)); do
            local pname ptype pdefault phelp poptions
            pname=$(echo "$params_json" | "$YQ" eval ".[$i].name" -)
            ptype=$(echo "$params_json" | "$YQ" eval ".[$i].type // \"input\"" -)
            pdefault=$(echo "$params_json" | "$YQ" eval ".[$i].default // \"\"" -)
            phelp=$(echo "$params_json" | "$YQ" eval ".[$i].help // \"\"" -)

            echo -e "  ${CYAN}$pname${NC} ($ptype)"
            [[ -n "$phelp" && "$phelp" != "null" ]] && echo "    Help: $phelp"
            [[ -n "$pdefault" && "$pdefault" != "null" ]] && echo "    Default: $pdefault"

            if [[ "$ptype" == "select" ]]; then
                poptions=$(echo "$params_json" | "$YQ" eval ".[$i].options | join(\", \")" - 2>/dev/null || true)
                [[ -n "$poptions" && "$poptions" != "null" ]] && echo "    Options: $poptions"
            fi
        done
    fi
}

# -----------------------------------------------------------------------------
# 主入口
# -----------------------------------------------------------------------------
main() {
    check_deps

    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list|ls)      cmd_list "$@" ;;
        show|info)    cmd_show "$@" ;;
        run|exec)     cmd_run "$@" ;;
        version|-v|--version)   cmd_version ;;
        help|-h|--help)         cmd_help ;;
        *)            die "未知命令: $cmd，运行 'ez help' 查看帮助" ;;
    esac
}

main "$@"
