#!/usr/bin/env bash
#
# EZ - go-task 智能前端
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/ez-core.sh"

# -----------------------------------------------------------------------------
# 命令: version
# -----------------------------------------------------------------------------
cmd_version() {
    echo "ez version $EZ_VERSION"
    echo ""
    echo "Dependencies:"
    echo "  yq:   $("$YQ" --version 2>/dev/null | head -1)"
    echo "  task: $("$TASK" --version 2>/dev/null | head -1)"
}

# -----------------------------------------------------------------------------
# 命令: help
# -----------------------------------------------------------------------------
cmd_help() {
    cat << 'EOF'
EZ - go-task 智能前端

用法:
    ez <command> [options] [args]

命令:
    list              列出所有任务
    show <task>       显示任务详情
    run <task>        运行任务（交互式参数）
    version           显示版本信息
    help              显示帮助

选项:
    -t, --taskfile    指定 Taskfile 路径
    --dry-run         只显示命令，不执行

示例:
    ez list
    ez show build
    ez run build
    ez run build --dry-run
EOF
}

# -----------------------------------------------------------------------------
# 命令: list
# -----------------------------------------------------------------------------
cmd_list() {
    local taskfile
    taskfile=$(find_taskfile ".") || die "未找到 Taskfile"

    echo -e "${BOLD}Tasks in ${taskfile}:${NC}"
    echo ""

    local tasks
    tasks=$(get_tasks "$taskfile")

    if [[ -z "$tasks" ]]; then
        echo "  (无任务)"
        return
    fi

    while IFS= read -r name; do
        [[ -z "$name" ]] && continue
        local desc param_flag=""
        desc=$(get_task_prop "$taskfile" "$name" "desc")
        has_ez_params "$taskfile" "$name" && param_flag=" ${CYAN}[params]${NC}"
        printf "  ${GREEN}%-20s${NC} %s%s\n" "$name" "$desc" "$param_flag"
    done <<< "$tasks"
}

# -----------------------------------------------------------------------------
# 命令: show
# -----------------------------------------------------------------------------
cmd_show() {
    local task="${1:-}"
    [[ -z "$task" ]] && die "用法: ez show <task>"

    local taskfile
    taskfile=$(find_taskfile ".") || die "未找到 Taskfile"

    # 检查任务是否存在
    local exists
    exists=$("$YQ" eval ".tasks.\"$task\" // \"\"" "$taskfile")
    [[ -z "$exists" || "$exists" == "null" ]] && die "任务未找到: $task"

    echo -e "${BOLD}Task: ${GREEN}$task${NC}"
    echo ""

    # 描述
    local desc
    desc=$(get_task_prop "$taskfile" "$task" "desc")
    [[ -n "$desc" ]] && echo -e "${BOLD}Description:${NC} $desc" && echo ""

    # 命令
    echo -e "${BOLD}Commands:${NC}"
    "$YQ" eval ".tasks.\"$task\".cmds[].cmd // .tasks.\"$task\".cmds[]" "$taskfile" 2>/dev/null | while IFS= read -r cmd; do
        [[ -n "$cmd" ]] && echo "  - $cmd"
    done
    echo ""

    # EZ 参数
    if has_ez_params "$taskfile" "$task"; then
        echo -e "${BOLD}Parameters:${NC}"
        local params_json
        params_json=$(get_ez_params_json "$taskfile" "$task")
        local count
        count=$(echo "$params_json" | "$YQ" eval 'length' -)

        for ((i=0; i<count; i++)); do
            local pname ptype pdefault phelp poptions query_cmd query_url
            pname=$(echo "$params_json" | "$YQ" eval ".[$i].name" -)
            ptype=$(echo "$params_json" | "$YQ" eval ".[$i].type // \"input\"" -)
            pdefault=$(echo "$params_json" | "$YQ" eval ".[$i].default // \"\"" -)
            phelp=$(echo "$params_json" | "$YQ" eval ".[$i].help // \"\"" -)
            query_cmd=$(echo "$params_json" | "$YQ" eval ".[$i].query.command // \"\"" -)
            query_url=$(echo "$params_json" | "$YQ" eval ".[$i].query.url // \"\"" -)

            # 变量名
            local varname="EZ_$(echo "$pname" | tr '[:lower:]-' '[:upper:]_')"

            echo ""
            echo -e "  ${CYAN}$pname${NC} ${YELLOW}($ptype)${NC} → ${GREEN}\${{.$varname}}${NC}"

            # 帮助信息（支持多行）
            if [[ -n "$phelp" && "$phelp" != "null" ]]; then
                echo "$phelp" | while IFS= read -r line; do
                    echo -e "    ${BLUE}$line${NC}"
                done
            fi

            # 默认值
            [[ -n "$pdefault" && "$pdefault" != "null" ]] && echo -e "    Default: ${GREEN}$pdefault${NC}"

            # 静态选项
            if [[ "$ptype" == "select" ]]; then
                poptions=$(echo "$params_json" | "$YQ" eval ".[$i].options | join(\", \")" - 2>/dev/null || true)
                [[ -n "$poptions" && "$poptions" != "null" ]] && echo -e "    Options: $poptions"
            fi

            # 动态查询
            if [[ -n "$query_cmd" && "$query_cmd" != "null" ]]; then
                echo -e "    Source: ${CYAN}command${NC} → $query_cmd"
            elif [[ -n "$query_url" && "$query_url" != "null" ]]; then
                local query_jq
                query_jq=$(echo "$params_json" | "$YQ" eval ".[$i].query.jq // \"\"" -)
                echo -e "    Source: ${CYAN}url${NC} → $query_url"
                [[ -n "$query_jq" && "$query_jq" != "null" ]] && echo -e "    Filter: $query_jq"
            fi
        done
        echo ""

        # 使用示例
        echo -e "${BOLD}Usage:${NC}"
        echo -e "  ./ez run $task"
        local example_vars=""
        for ((i=0; i<count; i++)); do
            local pname pdefault
            pname=$(echo "$params_json" | "$YQ" eval ".[$i].name" -)
            pdefault=$(echo "$params_json" | "$YQ" eval ".[$i].default // \"value\"" -)
            local varname="EZ_$(echo "$pname" | tr '[:lower:]-' '[:upper:]_')"
            example_vars+=" $varname=$pdefault"
        done
        echo -e "  ./ez run $task$example_vars"
    fi
}

# -----------------------------------------------------------------------------
# 交互式参数选择
# -----------------------------------------------------------------------------
select_value() {
    local name="$1" type="$2" options_json="$3" default="$4" help="$5"

    # 所有交互输出到 stderr，只有结果输出到 stdout
    echo -e "${BOLD}$name${NC}" >&2
    [[ -n "$help" && "$help" != "null" ]] && echo -e "  ${CYAN}$help${NC}" >&2

    if [[ "$type" == "select" ]]; then
        local opts=()
        while IFS= read -r opt; do
            [[ -n "$opt" ]] && opts+=("$opt")
        done < <(echo "$options_json" | "$YQ" eval '.[]' - 2>/dev/null)

        if [[ ${#opts[@]} -gt 0 ]]; then
            local i=1
            for opt in "${opts[@]}"; do
                local marker=""
                [[ "$opt" == "$default" ]] && marker=" (default)"
                echo "    $i) $opt$marker" >&2
                ((i++))
            done

            while true; do
                read -rp "  Choice [1-${#opts[@]}]: " choice </dev/tty
                # 回车使用默认值
                if [[ -z "$choice" && -n "$default" ]]; then
                    echo "$default"
                    return
                fi
                if [[ "$choice" =~ ^[0-9]+$ ]] && ((choice >= 1 && choice <= ${#opts[@]})); then
                    echo "${opts[$((choice-1))]}"
                    return
                fi
                echo "  无效选择，请重试" >&2
            done
        fi
    fi

    # input 类型或其他
    read -rp "  Value [$default]: " value </dev/tty
    echo "${value:-$default}"
}

# -----------------------------------------------------------------------------
# 命令: run
# -----------------------------------------------------------------------------
cmd_run() {
    local task="${1:-}"
    shift || true
    [[ -z "$task" ]] && die "用法: ez run <task> [options]"

    local taskfile dry_run=false
    taskfile=$(find_taskfile ".") || die "未找到 Taskfile"

    # 解析选项
    local -a extra_vars=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run) dry_run=true; shift ;;
            *=*) extra_vars+=("$1"); shift ;;
            *) shift ;;
        esac
    done

    # 收集 ez-params 参数（交互式）
    if has_ez_params "$taskfile" "$task"; then
        echo -e "${BOLD}Configure: ${GREEN}$task${NC}"
        echo ""

        local params_json
        params_json=$(get_ez_params_json "$taskfile" "$task")
        local count
        count=$(echo "$params_json" | "$YQ" eval 'length' -)

        for ((i=0; i<count; i++)); do
            local pname ptype poptions pdefault phelp value
            pname=$(echo "$params_json" | "$YQ" eval ".[$i].name" -)
            ptype=$(echo "$params_json" | "$YQ" eval ".[$i].type // \"input\"" -)
            poptions=$(echo "$params_json" | "$YQ" eval -o=json ".[$i].options // []" -)
            pdefault=$(echo "$params_json" | "$YQ" eval ".[$i].default // \"\"" -)
            phelp=$(echo "$params_json" | "$YQ" eval ".[$i].help // \"\"" -)

            # 检查是否已预设
            local varname="EZ_$(echo "$pname" | tr '[:lower:]-' '[:upper:]_')"
            local preset=""
            for v in "${extra_vars[@]}"; do
                [[ "$v" == "$varname="* ]] && preset="${v#*=}"
            done

            if [[ -n "$preset" ]]; then
                echo -e "${BOLD}$pname${NC}: $preset (preset)"
                value="$preset"
            else
                # 检查 query.command 动态获取选项
                local query_cmd query_url query_jq
                query_cmd=$(echo "$params_json" | "$YQ" eval ".[$i].query.command // \"\"" -)
                query_url=$(echo "$params_json" | "$YQ" eval ".[$i].query.url // \"\"" -)
                query_jq=$(echo "$params_json" | "$YQ" eval ".[$i].query.jq // \"\"" -)

                if [[ -n "$query_cmd" && "$query_cmd" != "null" && ("$poptions" == "[]" || "$poptions" == "null") ]]; then
                    echo -e "  ${CYAN}(query: $query_cmd)${NC}" >&2
                    local cmd_output
                    if cmd_output=$(eval "$query_cmd" 2>/dev/null); then
                        poptions=$(echo "$cmd_output" | "$YQ" -o=json -I0 'split("\n") | map(select(. != ""))')
                    fi
                elif [[ -n "$query_url" && "$query_url" != "null" && ("$poptions" == "[]" || "$poptions" == "null") ]]; then
                    echo -e "  ${CYAN}(fetch: $query_url)${NC}" >&2
                    local url_output
                    if url_output=$(curl -fsSL "$query_url" 2>/dev/null); then
                        if [[ -n "$query_jq" && "$query_jq" != "null" ]]; then
                            # 使用 jq 表达式提取数据
                            poptions=$(echo "$url_output" | "$YQ" -o=json "$query_jq")
                        else
                            # 假设返回的是每行一个选项
                            poptions=$(echo "$url_output" | "$YQ" -o=json -I0 'split("\n") | map(select(. != ""))')
                        fi
                    fi
                fi

                value=$(select_value "$pname" "$ptype" "$poptions" "$pdefault" "$phelp")
                extra_vars+=("$varname=$value")
            fi
            echo ""
        done
    fi

    # 构建命令
    local -a cmd=("$TASK" "-t" "$taskfile" "$task")
    for v in "${extra_vars[@]}"; do
        cmd+=("$v")
    done

    if $dry_run; then
        echo -e "${BOLD}Dry run:${NC} ${cmd[*]}"
        return 0
    fi

    echo -e "${BOLD}Running:${NC} ${cmd[*]}"
    echo ""
    "${cmd[@]}"
}

# -----------------------------------------------------------------------------
# 主入口
# -----------------------------------------------------------------------------
main() {
    check_deps

    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        list|ls)      cmd_list "$@" ;;
        show|info)    cmd_show "$@" ;;
        run|exec)     cmd_run "$@" ;;
        version|-v|--version)   cmd_version ;;
        help|-h|--help)         cmd_help ;;
        *)            die "未知命令: $cmd，运行 'ez help' 查看帮助" ;;
    esac
}

main "$@"
