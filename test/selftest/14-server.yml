# Server/Client 测试
version: '3'

tasks:
  all:
    desc: "运行所有 Server/Client 测试"
    cmds:
      - task: server-files
      - task: help-commands
      - task: server-help
      - task: docker-proxy
      - task: certs-dir
      - task: chart-files
      - cmd: echo "✓ 14-server 全部通过"

  server-files:
    desc: "检查服务器文件存在"
    cmds:
      - cmd: test -f ./server/main.py
      - cmd: test -f ./server/requirements.txt
      - cmd: test -f ./server/templates/index.html
      - cmd: test -f ./server/templates/nodes.html
      - cmd: test -f ./server/templates/tasks.html
      - cmd: test -f ./server/templates/jobs.html
      - cmd: test -f ./server/static/css/style.css
      - cmd: test -f ./server/client/agent.py
      - cmd: test -f ./server/Dockerfile
      - cmd: test -f ./server/docker-compose.yml
      - cmd: echo "✓ server files OK"

  help-commands:
    desc: "检查帮助包含 server/client 命令"
    cmds:
      - cmd: ./ez help | grep -q "server help"
      - cmd: ./ez help | grep -q "client help"
      - cmd: ./ez help | grep -q "分布式"
      - cmd: echo "✓ help commands OK"

  server-help:
    desc: "检查 server/client help 子命令"
    cmds:
      - cmd: ./ez server help | grep -q "代理"
      - cmd: ./ez server help | grep -q "证书"
      - cmd: ./ez client help | grep -q "Client"
      - cmd: ./ez client help | grep -q "EZ_SERVER_URL"
      - cmd: echo "✓ server/client help OK"

  docker-proxy:
    desc: "Dockerfile 支持代理构建参数"
    cmds:
      - cmd: grep -q "ARG HTTP_PROXY" ./server/Dockerfile
      - cmd: grep -q "ARG HTTPS_PROXY" ./server/Dockerfile
      - cmd: grep -q "ubuntu" ./server/Dockerfile
      - cmd: grep -q "ca-certificates" ./server/Dockerfile
      - cmd: echo "✓ docker proxy OK"

  certs-dir:
    desc: "检查证书目录"
    cmds:
      - cmd: test -d ./server/certs
      - cmd: echo "✓ certs dir OK"

  chart-files:
    desc: "检查可视化文件"
    cmds:
      - cmd: test -f ./server/templates/charts.html
      - cmd: grep -q "chart.min.js" ./server/templates/charts.html
      - cmd: grep -q "formula-editor" ./server/templates/charts.html
      - cmd: echo "✓ chart files OK"
