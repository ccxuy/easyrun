# Workspace 隔离执行测试 (v2.0)
version: '3'

tasks:
  all:
    desc: "运行所有 Workspace 测试"
    cmds:
      - task: workspace-auto
      - task: workspace-named
      - task: workspace-dry-run
      - task: folder-task-workspace
      - task: workspace-dir-structure
      - task: cleanup
      - cmd: echo "✓ 17-workspace 全部通过"

  workspace-auto:
    desc: "测试 --workspace=auto 自动命名"
    cmds:
      - cmd: ./ez hello --workspace=auto | grep -q "Workspace:"
      - cmd: test -d workspace
      - cmd: "ls workspace/ | head -1 | grep -qE '^[0-9]{8}-[0-9]{6}-'"
      - cmd: echo "✓ workspace auto OK"

  workspace-named:
    desc: "测试 --workspace=mytest 指定名称"
    cmds:
      - cmd: ./ez hello --workspace=mytest | grep -q "Workspace:"
      - cmd: test -d workspace/mytest
      - cmd: test -L workspace/mytest/src
      - cmd: test -f workspace/mytest/Taskfile.yml
      - cmd: echo "✓ workspace named OK"

  workspace-dry-run:
    desc: "测试 workspace + dry-run"
    cmds:
      - cmd: ./ez hello --workspace=drytest --dry-run | grep -q "Dry run"
      - cmd: test -d workspace/drytest
      - cmd: echo "✓ workspace dry-run OK"

  folder-task-workspace:
    desc: "测试目录任务默认 workspace 执行"
    cmds:
      # 创建测试目录任务
      - cmd: ./ez new ws-test-task
      # 默认执行（在 workspace 中）
      - cmd: ./ez ws-test-task | grep -q "Task:"
      - cmd: test -d workspace/ws-test-task
      # --no-workspace 直接执行
      - cmd: ./ez ws-test-task --no-workspace | grep -q "TODO"
      # 清理
      - cmd: rm -rf tasks/ws-test-task workspace/ws-test-task
      - cmd: echo "✓ dir-task workspace OK"

  workspace-dir-structure:
    desc: "测试 workspace/ 在项目根目录"
    cmds:
      # workspace/ 根目录应存在（前面的测试已创建）
      - cmd: test -d workspace
      - cmd: echo "✓ workspace dir structure OK"

  cleanup:
    desc: "清理测试工作区"
    cmds:
      - cmd: rm -rf workspace/mytest
      - cmd: rm -rf workspace/drytest
      # 清理 auto 工作区（匹配日期模式）
      - cmd: 'find workspace/ -maxdepth 1 -type d -name "20*" -exec rm -rf {} + 2>/dev/null || true'
      - cmd: echo "✓ cleanup OK"
