<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>计划 - EZ 管理平台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EZ 管理平台</div>
        <div class="nav-links">
            <a href="/">总览</a>
            <a href="/tasks">任务</a>
            <a href="/plans" class="active">计划</a>
            <a href="/executions">执行记录</a>
            <a href="/nodes">节点</a>
            <a href="/settings">设置</a>
        </div>
    </nav>

    <main class="container">
        <div class="toast-container" id="toast-container"></div>

        <div class="page-header-row">
            <div class="page-header">
                <h1>工作流计划</h1>
                <p>编排和执行多步骤工作流</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">+ 新建计划</button>
        </div>

        <div id="plans-container">
            <div class="loading">加载中...</div>
        </div>
    </main>

    <!-- Create Plan Modal -->
    <div class="modal-overlay" id="create-modal" style="display:none;" onclick="closeModalBg(event)">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h3>新建计划</h3>
            <div class="form-group">
                <label>计划名称 *</label>
                <input type="text" id="new-plan-name" placeholder="如: build-pipeline" pattern="[a-zA-Z0-9_-]+">
                <div style="font-size:0.8rem; color:var(--text-muted);">只允许字母、数字、下划线和连字符</div>
            </div>
            <div class="form-group">
                <label>描述</label>
                <input type="text" id="new-plan-desc" placeholder="简短描述计划用途">
            </div>
            <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
                <button class="btn" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="createPlan()">创建</button>
            </div>
        </div>
    </div>

    <script>
        async function loadPlans() {
            try {
                var res = await fetch('/api/v1/plans');
                var data = await res.json();
                var plans = data.plans || [];

                if (plans.length === 0) {
                    document.getElementById('plans-container').innerHTML =
                        '<div class="card"><div class="empty-state" style="text-align:center; padding:3rem;">' +
                        '<div style="font-size:3rem; margin-bottom:1rem; opacity:0.3;">&#128203;</div>' +
                        '<h3 style="margin-bottom:0.5rem;">暂无计划</h3>' +
                        '<p style="color:var(--text-muted); margin-bottom:1rem;">创建一个工作流计划来编排多步骤任务</p>' +
                        '<button class="btn btn-primary" onclick="openCreateModal()">+ 新建计划</button>' +
                        '</div></div>';
                    return;
                }

                var html = '<div class="card" style="padding:0; overflow:hidden;">' +
                    '<table class="table">' +
                    '<thead><tr>' +
                    '<th>名称</th>' +
                    '<th>描述</th>' +
                    '<th style="width:80px;">步骤数</th>' +
                    '<th style="width:140px;">最近执行</th>' +
                    '<th style="width:80px;">状态</th>' +
                    '<th style="width:140px;">操作</th>' +
                    '</tr></thead><tbody>';

                plans.forEach(function(plan) {
                    var lastRunHtml = '';
                    var lastStatusHtml = '';
                    if (plan.last_run) {
                        lastRunHtml = formatTimeAgo(plan.last_run.finished_at);
                        lastStatusHtml = statusBadgeHtml(plan.last_run.status);
                    } else {
                        lastRunHtml = '<span style="color:var(--text-muted);">-</span>';
                        lastStatusHtml = '<span style="color:var(--text-muted);">-</span>';
                    }

                    html += '<tr onclick="window.location=\'/plans/' + encodeURIComponent(plan.name) + '\'" style="cursor:pointer;">' +
                        '<td><strong>' + escapeHtml(plan.name) + '</strong></td>' +
                        '<td style="color:var(--text-muted); font-size:0.88rem;">' + escapeHtml(plan.desc || '') + '</td>' +
                        '<td>' + (plan.step_count || 0) + '</td>' +
                        '<td style="font-size:0.85rem;">' + lastRunHtml + '</td>' +
                        '<td>' + lastStatusHtml + '</td>' +
                        '<td onclick="event.stopPropagation();">' +
                        '<div style="display:flex; gap:0.3rem;">' +
                        '<button class="btn btn-sm btn-primary" onclick="runPlan(\'' + escapeHtml(plan.name) + '\')">执行</button>' +
                        '<button class="btn btn-sm btn-danger" onclick="deletePlan(\'' + escapeHtml(plan.name) + '\')">删除</button>' +
                        '</div></td>' +
                        '</tr>';
                });

                html += '</tbody></table></div>';
                document.getElementById('plans-container').innerHTML = html;
            } catch (e) {
                document.getElementById('plans-container').innerHTML =
                    '<div class="card"><div class="empty">加载失败: ' + escapeHtml(e.message) + '</div></div>';
            }
        }

        async function runPlan(name) {
            if (!confirm('执行计划 "' + name + '"?')) return;
            try {
                var res = await fetch('/api/v1/plans/' + encodeURIComponent(name) + '/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                var data = await res.json();
                if (data.run_id) {
                    showToast('计划已启动: ' + data.run_id, 'success');
                    window.location.href = '/executions/' + data.run_id;
                } else {
                    showToast('启动失败: ' + (data.error || '未知'), 'error');
                }
            } catch (e) {
                showToast('请求失败: ' + e.message, 'error');
            }
        }

        async function deletePlan(name) {
            if (!confirm('确定删除计划 "' + name + '"?')) return;
            try {
                var res = await fetch('/api/v1/plans/' + encodeURIComponent(name), {method: 'DELETE'});
                var data = await res.json();
                if (data.ok) {
                    showToast('已删除', 'success');
                    loadPlans();
                } else {
                    showToast('删除失败: ' + (data.error || '未知'), 'error');
                }
            } catch (e) {
                showToast('请求失败: ' + e.message, 'error');
            }
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('create-modal').style.display = 'none';
        }

        function closeModalBg(e) {
            if (e.target === e.currentTarget) closeModal();
        }

        async function createPlan() {
            var name = document.getElementById('new-plan-name').value.trim();
            var desc = document.getElementById('new-plan-desc').value.trim();
            if (!name) { showToast('名称不能为空', 'error'); return; }

            try {
                var res = await fetch('/api/v1/plans', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: name, desc: desc})
                });
                var data = await res.json();
                if (data.ok) {
                    closeModal();
                    showToast('创建成功', 'success');
                    window.location.href = '/plans/' + encodeURIComponent(name);
                } else {
                    showToast('创建失败: ' + (data.error || '未知'), 'error');
                }
            } catch (e) {
                showToast('请求失败: ' + e.message, 'error');
            }
        }

        loadPlans();
    </script>
</body>
</html>
