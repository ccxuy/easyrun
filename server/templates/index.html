<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZ 管理平台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EZ 管理平台</div>
        <div class="nav-links">
            <a href="/" class="active">总览</a>
            <a href="/tasks">任务</a>
            <a href="/plans">计划</a>
            <a href="/executions">执行记录</a>
            <a href="/nodes">节点</a>
            <a href="/settings">设置</a>
        </div>
    </nav>

    <main class="container">
        <div class="toast-container" id="toast-container"></div>

        <div class="page-header">
            <h1>运营概览</h1>
            <p>24 小时执行统计与系统状态</p>
        </div>

        <!-- Stat Strip -->
        <div class="stat-grid" style="margin-bottom:1.5rem;">
            <div class="card stat-card" id="stat-active">
                <div class="stat-value">-</div>
                <div class="stat-label">活跃运行</div>
            </div>
            <div class="card stat-card" id="stat-rate">
                <div class="stat-value">-</div>
                <div class="stat-label">成功率 (24h)</div>
            </div>
            <div class="card stat-card" id="stat-failed">
                <div class="stat-value">-</div>
                <div class="stat-label">失败 (24h)</div>
            </div>
            <div class="card stat-card" id="stat-nodes">
                <div class="stat-value">-</div>
                <div class="stat-label">在线节点</div>
            </div>
        </div>

        <!-- Main grid -->
        <div class="dashboard-grid">
            <!-- Left: Attention + Quick actions -->
            <div>
                <!-- Attention items -->
                <div class="card" style="margin-bottom:1.2rem;">
                    <h3 style="margin-bottom:0.8rem;">需关注事项</h3>
                    <ul class="attention-list" id="attention-list">
                        <li class="attention-item" style="color:var(--text-muted);">加载中...</li>
                    </ul>

                    <div class="quick-actions">
                        <a href="/executions?run=" class="btn btn-sm btn-primary">执行任务</a>
                        <a href="/plans" class="btn btn-sm">执行计划</a>
                        <a href="/tasks/new" class="btn btn-sm">+ 新任务</a>
                    </div>
                </div>

                <!-- Recent executions -->
                <div class="card" style="padding:0; overflow:hidden;">
                    <div style="padding:1rem 1.2rem 0.5rem;">
                        <h3>最近执行</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:60px;">类型</th>
                                <th>名称</th>
                                <th style="width:70px;">状态</th>
                                <th style="width:80px;">耗时</th>
                                <th style="width:80px;">时间</th>
                            </tr>
                        </thead>
                        <tbody id="recent-body">
                            <tr><td colspan="5" class="loading">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right: Activity feed -->
            <div>
                <div class="card">
                    <h3 style="margin-bottom:0.8rem;">活动流</h3>
                    <div class="activity-feed" id="activity-feed">
                        <div style="color:var(--text-muted); font-size:0.88rem;">等待活动...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        var socket = io();
        var activityItems = [];

        async function loadDashboard() {
            try {
                var res = await fetch('/api/v1/dashboard');
                var data = await res.json();

                // Stats
                var stats = data.stats_24h || {};
                var nodesSummary = data.nodes_summary || {};

                document.querySelector('#stat-active .stat-value').textContent = (data.active_runs || []).length;
                document.querySelector('#stat-rate .stat-value').textContent = (stats.success_rate || 0) + '%';
                document.querySelector('#stat-failed .stat-value').textContent = stats.failed || 0;
                document.querySelector('#stat-nodes .stat-value').textContent =
                    (nodesSummary.online || 0) + '/' + (nodesSummary.total || 0);

                // Color coding
                var failedEl = document.querySelector('#stat-failed .stat-value');
                if (stats.failed > 0) failedEl.style.color = 'var(--danger)';
                else failedEl.style.color = '';

                // Attention
                var attHtml = '';
                var activeRuns = data.active_runs || [];
                var failed24h = data.failed_24h || [];

                if (activeRuns.length === 0 && failed24h.length === 0) {
                    attHtml = '<li class="attention-item" style="color:var(--text-muted);">一切正常</li>';
                }

                activeRuns.forEach(function(r) {
                    var progress = '';
                    if (r.total_steps) progress = ' (' + (r.completed_steps || 0) + '/' + r.total_steps + ')';
                    attHtml += '<li class="attention-item">' +
                        statusBadgeHtml(r.status) +
                        ' <a href="/executions/' + encodeURIComponent(r.id) + '">' + escapeHtml(r.name || r.id) + '</a>' +
                        escapeHtml(progress) +
                        ' <span style="color:var(--text-muted); font-size:0.8rem;">' + escapeHtml(r.type) + '</span>' +
                        '</li>';
                });

                failed24h.forEach(function(f) {
                    attHtml += '<li class="attention-item">' +
                        statusBadgeHtml(f.status) +
                        ' <a href="/executions/' + encodeURIComponent(f.id) + '">' + escapeHtml(f.name || f.id) + '</a>' +
                        ' <span style="font-size:0.8rem; color:var(--text-muted);">' + formatTimeAgo(f.finished_at) + '</span>' +
                        '</li>';
                });

                document.getElementById('attention-list').innerHTML = attHtml;
            } catch (e) {
                document.getElementById('attention-list').innerHTML =
                    '<li class="attention-item" style="color:var(--danger);">加载失败: ' + escapeHtml(e.message) + '</li>';
            }
        }

        async function loadRecent() {
            try {
                var res = await fetch('/api/v1/executions?limit=10');
                var data = await res.json();
                var execs = data.executions || [];

                if (execs.length === 0) {
                    document.getElementById('recent-body').innerHTML =
                        '<tr><td colspan="5" class="empty">暂无执行记录</td></tr>';
                    return;
                }

                var html = '';
                execs.forEach(function(ex) {
                    var duration = '-';
                    if (ex.duration) duration = formatDurationSec(ex.duration);
                    else if (ex.started_at && ex.finished_at) duration = formatDuration(ex.started_at, ex.finished_at);

                    html += '<tr onclick="window.location=\'/executions/' + encodeURIComponent(ex.id) + '\'" style="cursor:pointer;">' +
                        '<td>' + execTypeBadgeHtml(ex.type) + '</td>' +
                        '<td>' + escapeHtml(ex.name || '-') + '</td>' +
                        '<td>' + statusBadgeHtml(ex.status) + '</td>' +
                        '<td style="font-size:0.82rem;">' + escapeHtml(duration) + '</td>' +
                        '<td style="font-size:0.82rem; color:var(--text-muted);">' + formatTimeAgo(ex.created_at) + '</td>' +
                        '</tr>';
                });
                document.getElementById('recent-body').innerHTML = html;
            } catch (e) {
                document.getElementById('recent-body').innerHTML =
                    '<tr><td colspan="5" class="empty">加载失败</td></tr>';
            }
        }

        // Activity feed (WebSocket events)
        function addActivity(msg) {
            activityItems.unshift({msg: msg, time: new Date().toISOString()});
            if (activityItems.length > 20) activityItems.pop();
            renderFeed();
        }

        function renderFeed() {
            var html = '';
            activityItems.forEach(function(item) {
                html += '<div class="feed-item">' +
                    escapeHtml(item.msg) +
                    ' <span class="feed-time">' + formatTimeAgo(item.time) + '</span>' +
                    '</div>';
            });
            if (!html) html = '<div style="color:var(--text-muted); font-size:0.88rem;">等待活动...</div>';
            document.getElementById('activity-feed').innerHTML = html;
        }

        socket.on('job_update', function(data) {
            if (data) addActivity((data.task || data.id) + ' - ' + (statusLabels[data.status] || data.status));
            loadDashboard();
            loadRecent();
        });
        socket.on('plan_update', function(data) {
            if (data) addActivity('计划 ' + (data.plan_name || data.id) + ' - ' + (statusLabels[data.status] || data.status));
            loadDashboard();
            loadRecent();
        });
        socket.on('plan_step_update', function(data) {
            if (data) addActivity(data.step_name + ' (' + data.plan_name + ') - ' + (statusLabels[data.status] || data.status));
        });
        socket.on('node_update', function(data) {
            if (data) addActivity('节点 ' + (data.name || data.id) + ' - ' + (data.status || ''));
            loadDashboard();
        });

        // Init
        loadDashboard();
        loadRecent();
        setInterval(function() { loadDashboard(); loadRecent(); }, 15000);
    </script>
</body>
</html>
