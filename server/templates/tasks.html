<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务 - EZ 管理平台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/common.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EZ 管理平台</div>
        <div class="nav-links">
            <a href="/">总览</a>
            <a href="/tasks" class="active">任务</a>
            <a href="/plans">计划</a>
            <a href="/executions">执行记录</a>
            <a href="/nodes">节点</a>
            <a href="/settings">设置</a>
        </div>
    </nav>

    <main class="container">
        <div class="toast-container" id="toast-container"></div>

        <div class="page-header-row">
            <div class="page-header">
                <h1>任务定义</h1>
                <p>创建、浏览和编辑任务定义</p>
            </div>
            <a href="/tasks/new" class="btn btn-primary">+ 新建任务</a>
        </div>

        <!-- Filter bar -->
        <div class="filter-bar">
            <input type="text" id="search-input" placeholder="搜索任务名..." oninput="filterTasks()">
            <select id="type-filter" onchange="filterTasks()">
                <option value="">全部类型</option>
                <option value="dir">文件夹 (dir)</option>
                <option value="inline">行内 (inline)</option>
                <option value="tool">工具 (tool)</option>
                <option value="namespace">命名空间</option>
            </select>
        </div>

        <!-- Table -->
        <div class="card" style="padding:0; overflow:hidden;">
            <table class="table" id="task-table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th style="width:80px;">类型</th>
                        <th>描述</th>
                        <th style="width:60px;">参数</th>
                        <th style="width:70px;"></th>
                    </tr>
                </thead>
                <tbody id="task-body">
                    <tr><td colspan="5" class="loading">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        var allTasks = [];

        async function loadTasks() {
            try {
                var res = await fetch('/api/v1/tasks/tree');
                var data = await res.json();
                allTasks = data.tree || [];
                filterTasks();
            } catch (e) {
                document.getElementById('task-body').innerHTML =
                    '<tr><td colspan="5" class="empty">加载失败: ' + escapeHtml(e.message) + '</td></tr>';
            }
        }

        function filterTasks() {
            var search = (document.getElementById('search-input').value || '').toLowerCase();
            var typeFilter = document.getElementById('type-filter').value;

            var html = '';
            var count = 0;

            allTasks.forEach(function(task) {
                if (task.type === 'namespace' && task.children) {
                    var matchedChildren = (task.children || []).filter(function(c) {
                        if (search && c.name.toLowerCase().indexOf(search) < 0 && (c.desc || '').toLowerCase().indexOf(search) < 0) return false;
                        if (typeFilter && typeFilter !== 'namespace' && c.type !== typeFilter) return false;
                        return true;
                    });

                    var nsMatch = (!search || task.name.toLowerCase().indexOf(search) >= 0) && (!typeFilter || typeFilter === 'namespace');

                    if (nsMatch || matchedChildren.length > 0) {
                        html += '<tr style="background:var(--bg-color);">' +
                            '<td colspan="5" style="padding:0.5rem 0.8rem; font-weight:600; cursor:pointer;" onclick="toggleNs(this)">' +
                            '<span class="ns-arrow" style="display:inline-block; transition:transform 0.2s; margin-right:0.3rem;">&#9660;</span>' +
                            escapeHtml(task.name) +
                            ' <span style="font-weight:400; color:var(--text-muted); font-size:0.82rem;">' + (task.children.length) + ' 个子任务</span>' +
                            '</td></tr>';
                        count++;

                        matchedChildren.forEach(function(c) {
                            html += renderTaskRow(c, true);
                            count++;
                        });
                    }
                } else {
                    if (search && task.name.toLowerCase().indexOf(search) < 0 && (task.desc || '').toLowerCase().indexOf(search) < 0) return;
                    if (typeFilter && task.type !== typeFilter) return;
                    html += renderTaskRow(task, false);
                    count++;
                }
            });

            if (count === 0) {
                html = '<tr><td colspan="5" class="empty">没有匹配的任务</td></tr>';
            }

            document.getElementById('task-body').innerHTML = html;
        }

        function renderTaskRow(task, isChild) {
            var typeBadge = '';
            if (task.type === 'dir') typeBadge = '<span class="badge badge-dir">dir</span>';
            else if (task.type === 'tool') typeBadge = '<span class="badge badge-tool">tool</span>';
            else if (task.type === 'inline') typeBadge = '<span class="badge badge-params">inline</span>';
            else typeBadge = '<span class="badge">' + escapeHtml(task.type || '') + '</span>';

            var paramCount = task.has_params ? (task.param_count || '?') : '0';

            var actionHtml = '';
            if (task.type === 'tool') {
                actionHtml = '<a href="/tasks/' + encodeURIComponent(task.name) + '" class="btn btn-sm">查看</a>';
            } else {
                actionHtml = '<a href="/tasks/' + encodeURIComponent(task.name) + '" class="btn btn-sm btn-primary">编辑</a>';
            }

            return '<tr class="' + (isChild ? 'ns-child' : '') + '" onclick="window.location=\'/tasks/' + encodeURIComponent(task.name) + '\'" style="cursor:pointer;">' +
                '<td style="' + (isChild ? 'padding-left:2rem;' : '') + '">' + escapeHtml(task.name) + '</td>' +
                '<td>' + typeBadge + '</td>' +
                '<td style="color:var(--text-muted); font-size:0.88rem;">' + escapeHtml(task.desc || '') + '</td>' +
                '<td style="text-align:center;">' + escapeHtml(String(paramCount)) + '</td>' +
                '<td onclick="event.stopPropagation();">' + actionHtml + '</td>' +
                '</tr>';
        }

        function toggleNs(el) {
            var row = el.parentElement;
            var arrow = el.querySelector('.ns-arrow');
            var hidden = false;
            var next = row.nextElementSibling;
            while (next && next.classList.contains('ns-child')) {
                if (next.style.display === 'none') {
                    next.style.display = '';
                    hidden = false;
                } else {
                    next.style.display = 'none';
                    hidden = true;
                }
                next = next.nextElementSibling;
            }
            arrow.style.transform = hidden ? 'rotate(-90deg)' : '';
        }

        loadTasks();
    </script>
</body>
</html>
