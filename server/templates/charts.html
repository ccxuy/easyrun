<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计 - EZ 管理平台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/chart.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">EZ 管理平台</div>
        <div class="nav-links">
            <a href="/">总览</a>
            <a href="/tasks">任务</a>
            <a href="/plans">计划</a>
            <a href="/jobs">执行记录</a>
            <a href="/nodes">节点</a>
            <a href="/charts" class="active">统计</a>
        </div>
    </nav>

    <main class="container">
        <div class="toast-container" id="toast-container"></div>
        <div class="page-header">
            <h1>数据统计</h1>
            <p>可视化执行趋势与任务分析</p>
        </div>

        <!-- 时间范围选择器 -->
        <div class="time-range">
            <button class="active" onclick="setRange(1, this)">24小时</button>
            <button onclick="setRange(7, this)">7天</button>
            <button onclick="setRange(30, this)">30天</button>
        </div>

        <!-- 统计概览卡片 -->
        <div class="stat-grid" style="margin-bottom:1.5rem;">
            <div class="stat-card primary">
                <div class="stat-value" id="s-total">-</div>
                <div class="stat-label">总执行</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="s-success">-</div>
                <div class="stat-label">成功</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="s-failed">-</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="s-rate">-</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>

        <!-- 2x2 图表网格 -->
        <div class="chart-grid">
            <!-- 1. 执行趋势 -->
            <div class="chart-card">
                <h3>执行趋势</h3>
                <div class="chart-wrapper">
                    <canvas id="chart-trend"></canvas>
                </div>
            </div>

            <!-- 2. 任务分布 -->
            <div class="chart-card">
                <h3>任务分布</h3>
                <div class="chart-wrapper">
                    <canvas id="chart-dist"></canvas>
                </div>
            </div>

            <!-- 3. 耗时分析 -->
            <div class="chart-card">
                <h3>耗时分析</h3>
                <div class="chart-wrapper">
                    <canvas id="chart-duration"></canvas>
                </div>
            </div>

            <!-- 4. 成功率 -->
            <div class="chart-card">
                <h3>任务成功率</h3>
                <div class="chart-wrapper">
                    <canvas id="chart-success-rate"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        var charts = {};
        var statsData = null;
        var currentRange = 30; // 默认 30 天

        function setRange(days, btn) {
            currentRange = days;
            document.querySelectorAll('.time-range button').forEach(function(b) {
                b.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            loadStats();
        }

        function filterByRange(data) {
            if (!data) return data;
            var cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - currentRange);
            var cutoffStr = cutoff.toISOString().slice(0, 10);

            // 过滤 timeline
            var filtered = Object.assign({}, data);
            if (filtered.timeline) {
                filtered.timeline = filtered.timeline.filter(function(d) {
                    return d.date >= cutoffStr;
                });
            }

            // 重新计算 summary 基于 raw_jobs
            if (filtered.raw_jobs) {
                var jobs = filtered.raw_jobs.filter(function(j) {
                    var d = (j.created_at || '').slice(0, 10);
                    return d >= cutoffStr;
                });

                var total = jobs.length;
                var success = 0, failed = 0;
                var taskMap = {};

                jobs.forEach(function(j) {
                    if (j.status === 'success') success++;
                    if (j.status === 'failed' || j.status === 'error') failed++;

                    var t = j.task || 'unknown';
                    if (!taskMap[t]) taskMap[t] = {task: t, total: 0, success: 0, failed: 0, durations: []};
                    taskMap[t].total++;
                    if (j.status === 'success') taskMap[t].success++;
                    if (j.status === 'failed' || j.status === 'error') taskMap[t].failed++;

                    if (j.started_at && j.finished_at) {
                        var dur = (new Date(j.finished_at) - new Date(j.started_at)) / 1000;
                        if (dur >= 0) taskMap[t].durations.push(dur);
                    }
                });

                filtered.summary = {
                    total_jobs: total,
                    success: success,
                    failed: failed,
                    success_rate: total > 0 ? Math.round(success / total * 1000) / 10 : 0
                };

                filtered.by_task = Object.values(taskMap);
            }

            return filtered;
        }

        async function loadStats() {
            try {
                var res = await fetch('/api/v1/stats');
                statsData = await res.json();
                var data = filterByRange(statsData);
                updateSummary(data);
                renderCharts(data);
            } catch (e) {
                console.error('加载统计失败:', e);
            }
        }

        function updateSummary(data) {
            if (!data || !data.summary) return;
            var s = data.summary;
            document.getElementById('s-total').textContent = s.total_jobs;
            document.getElementById('s-success').textContent = s.success;
            document.getElementById('s-failed').textContent = s.failed;
            document.getElementById('s-rate').textContent = s.success_rate + '%';
        }

        function createOrUpdate(canvasId, config) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            var ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, config);
        }

        function renderCharts(data) {
            if (!data) return;
            renderTrendChart(data);
            renderDistChart(data);
            renderDurationChart(data);
            renderSuccessRateChart(data);
        }

        // 1. 执行趋势 - 折线图
        function renderTrendChart(data) {
            var timeline = data.timeline || [];
            if (timeline.length === 0) {
                timeline = [{date: new Date().toISOString().slice(0, 10), total: 0, success: 0, failed: 0}];
            }

            var ctx = document.getElementById('chart-trend').getContext('2d');

            // 渐变填充
            var gradientTotal = ctx.createLinearGradient(0, 0, 0, 260);
            gradientTotal.addColorStop(0, 'rgba(22, 119, 255, 0.3)');
            gradientTotal.addColorStop(1, 'rgba(22, 119, 255, 0.02)');

            var gradientSuccess = ctx.createLinearGradient(0, 0, 0, 260);
            gradientSuccess.addColorStop(0, 'rgba(82, 196, 26, 0.25)');
            gradientSuccess.addColorStop(1, 'rgba(82, 196, 26, 0.02)');

            createOrUpdate('chart-trend', {
                type: 'line',
                data: {
                    labels: timeline.map(function(d) { return d.date; }),
                    datasets: [
                        {
                            label: '总执行',
                            data: timeline.map(function(d) { return d.total; }),
                            borderColor: '#1677ff',
                            backgroundColor: gradientTotal,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: '成功',
                            data: timeline.map(function(d) { return d.success; }),
                            borderColor: '#52c41a',
                            backgroundColor: gradientSuccess,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: '失败',
                            data: timeline.map(function(d) { return d.failed; }),
                            borderColor: '#ff4d4f',
                            backgroundColor: 'rgba(255, 77, 79, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800, easing: 'easeInOutQuart' },
                    plugins: {
                        legend: { labels: { usePointStyle: true, padding: 16, font: { size: 12 } } }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11 } } },
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11 } } }
                    }
                }
            });
        }

        // 2. 任务分布 - 环形图
        function renderDistChart(data) {
            var tasks = data.by_task || [];
            if (tasks.length === 0) {
                tasks = [{task: '暂无数据', total: 1}];
            }

            // 调色板
            var palette = [
                '#1677ff', '#52c41a', '#faad14', '#ff4d4f', '#722ed1',
                '#13c2c2', '#eb2f96', '#fa8c16', '#2f54eb', '#a0d911',
                '#597ef7', '#36cfc9', '#f759ab', '#ffc53d'
            ];

            createOrUpdate('chart-dist', {
                type: 'doughnut',
                data: {
                    labels: tasks.map(function(t) { return t.task; }),
                    datasets: [{
                        data: tasks.map(function(t) { return t.total; }),
                        backgroundColor: tasks.map(function(_, i) { return palette[i % palette.length]; }),
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800, easing: 'easeOutBounce', animateRotate: true },
                    cutout: '55%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { usePointStyle: true, padding: 12, font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 3. 耗时分析 - 柱状图 (渐变)
        function renderDurationChart(data) {
            var tasks = (data.by_task || []).filter(function(t) {
                return t.durations && t.durations.length > 0;
            });

            // 如果按 range 过滤后没有 durations, 使用全局 duration 数据
            if (tasks.length === 0 && data.duration) {
                var ctx = document.getElementById('chart-duration').getContext('2d');
                var gradient = ctx.createLinearGradient(0, 260, 0, 0);
                gradient.addColorStop(0, 'rgba(22, 119, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(22, 119, 255, 0.8)');

                createOrUpdate('chart-duration', {
                    type: 'bar',
                    data: {
                        labels: ['平均', '最小', '最大', 'P50', 'P90'],
                        datasets: [{
                            label: '耗时 (秒)',
                            data: [data.duration.avg, data.duration.min, data.duration.max,
                                   data.duration.p50, data.duration.p90],
                            backgroundColor: gradient,
                            borderColor: '#1677ff',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 800, easing: 'easeInOutQuart' },
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 11 } } },
                            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' },
                                 ticks: { font: { size: 11 }, callback: function(v) { return v + 's'; } } }
                        }
                    }
                });
                return;
            }

            // 计算每个任务的平均耗时
            var labels = [];
            var avgDurations = [];
            tasks.forEach(function(t) {
                labels.push(t.task);
                var sum = t.durations.reduce(function(a, b) { return a + b; }, 0);
                avgDurations.push(Math.round(sum / t.durations.length * 10) / 10);
            });

            var ctx = document.getElementById('chart-duration').getContext('2d');
            var gradient = ctx.createLinearGradient(0, 260, 0, 0);
            gradient.addColorStop(0, 'rgba(114, 46, 209, 0.15)');
            gradient.addColorStop(0.5, 'rgba(22, 119, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(19, 194, 194, 0.85)');

            createOrUpdate('chart-duration', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均耗时 (秒)',
                        data: avgDurations,
                        backgroundColor: gradient,
                        borderColor: 'rgba(22, 119, 255, 0.6)',
                        borderWidth: 1,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1000, easing: 'easeInOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) { return '平均 ' + ctx.raw + ' 秒'; }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11 }, maxRotation: 45 } },
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' },
                             ticks: { font: { size: 11 }, callback: function(v) { return v + 's'; } } }
                    }
                }
            });
        }

        // 4. 成功率 - 柱状图
        function renderSuccessRateChart(data) {
            var tasks = (data.by_task || []).filter(function(t) { return t.total > 0; });
            if (tasks.length === 0) {
                tasks = [{task: '暂无数据', total: 1, success: 0}];
            }

            var labels = tasks.map(function(t) { return t.task; });
            var rates = tasks.map(function(t) {
                return t.total > 0 ? Math.round(t.success / t.total * 1000) / 10 : 0;
            });

            // 根据成功率着色
            var colors = rates.map(function(r) {
                if (r >= 90) return 'rgba(82, 196, 26, 0.75)';
                if (r >= 70) return 'rgba(250, 173, 20, 0.75)';
                return 'rgba(255, 77, 79, 0.75)';
            });

            var borderColors = rates.map(function(r) {
                if (r >= 90) return '#52c41a';
                if (r >= 70) return '#faad14';
                return '#ff4d4f';
            });

            createOrUpdate('chart-success-rate', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '成功率 (%)',
                        data: rates,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800, easing: 'easeInOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) { return '成功率 ' + ctx.raw + '%'; }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11 }, maxRotation: 45 } },
                        y: {
                            beginAtZero: true, max: 100,
                            grid: { color: 'rgba(0,0,0,0.04)' },
                            ticks: { font: { size: 11 }, callback: function(v) { return v + '%'; } }
                        }
                    }
                }
            });
        }

        // 初始加载
        loadStats();

        // 定时刷新
        setInterval(loadStats, 30000);
    </script>

    <style>
        .chart-wrapper {
            position: relative;
            height: 280px;
        }

        .chart-wrapper canvas {
            max-height: 280px;
        }
    </style>
</body>
</html>
